name: Money Radar Pipeline

on:
  schedule:
    - cron: "*/10 * * * *" # frequent listings ingest (UTC)
    - cron: "0 3 * * *" # daily ingestion/scoring (UTC)
    - cron: "30 3 * * 0" # weekly clustering/extraction (UTC, Sunday)
  workflow_dispatch:
    inputs:
      mode:
        description: "daily or weekly"
        required: true
        default: "daily"
        type: choice
        options:
          - frequent
          - daily
          - weekly

permissions:
  contents: read

concurrency:
  group: money-radar-pipeline
  cancel-in-progress: false

jobs:
  frequent:
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '*/10 * * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'frequent')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/money-radar
    env:
      DATABASE_URL: ${{ secrets.MONEY_RADAR_DATABASE_URL }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      LLM_PROVIDER: groq
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "apps/money-radar/pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Init DB
        run: python -m ukmppr db init

      - name: Ingest listings (quick)
        run: python -m ukmppr ingest listings --limit 100 --pages 2

      - name: Score signals (hybrid, quick)
        run: python -m ukmppr score signals --method hybrid --hybrid-min-score 0.4 --limit-posts 200 --limit-comments 0

  daily:
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '0 3 * * *') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'daily')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/money-radar
    env:
      DATABASE_URL: ${{ secrets.MONEY_RADAR_DATABASE_URL }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      LLM_PROVIDER: groq
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "apps/money-radar/pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Init DB
        run: python -m ukmppr db init

      - name: Ingest listings
        run: python -m ukmppr ingest listings --limit 100 --pages 10

      - name: Ingest threads
        run: python -m ukmppr ingest threads --max-posts 40 --min-comments 5 --min-score 10 --comment-limit 300 --sort top

      - name: Score signals (hybrid)
        run: python -m ukmppr score signals --method hybrid --hybrid-min-score 0.3 --limit-posts 500 --limit-comments 2000

      - name: Compute trends
        run: python -m ukmppr trends compute --weeks 24

  weekly:
    if: >
      (github.event_name == 'schedule' && github.event.schedule == '30 3 * * 0') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'weekly')
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/money-radar
    env:
      DATABASE_URL: ${{ secrets.MONEY_RADAR_DATABASE_URL }}
      GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
      LLM_PROVIDER: groq
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "apps/money-radar/pyproject.toml"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install clustering extras
        run: |
          pip install bertopic sentence-transformers hdbscan umap-learn scikit-learn

      - name: Init DB
        run: python -m ukmppr db init

      - name: Cluster themes
        run: python -m ukmppr cluster run --limit 2000 --min-topic-size 8 --min-signal 0.3

      - name: Compute trends (long window)
        run: python -m ukmppr trends compute --weeks 52

      - name: LLM pain-point extraction
        run: python -m ukmppr extract run --limit 200 --min-signal 0.5
